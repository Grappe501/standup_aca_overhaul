---
// src/pages/library.astro
import SiteLayout from "../layouts/SiteLayout.astro";
import { getCollection } from "astro:content";

function normalizePath(p: string): string {
  if (!p) return "/";
  let s = p.startsWith("/") ? p : "/" + p;

  // Collapse duplicate slashes (e.g. "//proposal//overview" -> "/proposal/overview")
  s = s.replace(/\/{2,}/g, "/");

  // Strip trailing slash (except root)
  if (s.length > 1 && s.endsWith("/")) s = s.slice(0, -1);

  return s;
}

function routeFor(d: any): string {
  const raw = d?.data?.route || "/" + d.slug;
  return normalizePath(raw);
}

function labelFor(d: any): string {
  return d?.data?.title ?? d.slug;
}

function subtitleFor(d: any): string {
  // Optional fields if you add them later. Safe fallbacks.
  const s = d?.data?.description || d?.data?.summary || d?.data?.kicker || "";
  return typeof s === "string" ? s : "";
}

const hrefStart = normalizePath("/start-here");
const hrefProblem = normalizePath("/the-problem");
const hrefBackbone = normalizePath("/the-backbone");
const hrefProposal = normalizePath("/proposal");
const hrefLibrary = normalizePath("/library");

// Build-safe: if collection is missing/empty during ingestion, do not hard-fail.
let docs: any[] = [];
try {
  docs = (await getCollection("docs"))
    .slice()
    .sort((a, b) => {
      const ra = routeFor(a);
      const rb = routeFor(b);
      const rcmp = ra.localeCompare(rb);
      if (rcmp !== 0) return rcmp;
      return (a.data.title ?? a.slug).localeCompare(b.data.title ?? b.slug);
    });
} catch {
  docs = [];
}

const count = docs.length;
---

<SiteLayout title="Library — Stand Up Arkansas">
  <main class="library">
    <!-- Header -->
    <header class="header" aria-label="Library index">
      <div class="headerInner">
        <div class="headerLeft">
          <p class="eyebrow">Library</p>
          <h1 class="h1">Index of pages</h1>
          <p class="sub">
            Use this as the <strong>supporting index</strong>: find a specific section, cite it, and share it.
            For orientation, start with the guided overview first.
          </p>

          <div class="ctas" aria-label="Primary actions">
            <a class="btn primary" href={hrefStart}>Guided Overview</a>
            <a class="btn" href={hrefBackbone}>Backbone</a>
            <a class="btn ghost" href={hrefProposal}>Open Proposal</a>
          </div>

          <div class="meta" aria-label="Library status">
            <div class="meta-pill">
              <span class="dot neutral" aria-hidden="true"></span>
              <span>{count} item{count === 1 ? "" : "s"} available</span>
            </div>
            <div class="meta-pill">
              <span class="dot draft" aria-hidden="true"></span>
              <span>Re-ingesting sources</span>
            </div>
          </div>
        </div>

        <aside class="headerRight" aria-label="Quick routes">
          <div class="panel">
            <h2 class="panelTitle">Core routes</h2>

            <div class="panelGrid">
              <a class="mini" href={hrefProblem}>
                <span class="miniTop">Context</span>
                <span class="miniMain">The Problem</span>
              </a>
              <a class="mini" href={hrefBackbone}>
                <span class="miniTop">Mechanism</span>
                <span class="miniMain">The Backbone</span>
              </a>
              <a class="mini" href={hrefProposal}>
                <span class="miniTop">Deliverable</span>
                <span class="miniMain">The Proposal</span>
              </a>
            </div>

            <div class="panelFoot">
              <span class="pill">
                <span class="dot draft" aria-hidden="true"></span>
                Working build
              </span>
              <a class="btn" href={hrefStart}>Overview →</a>
            </div>
          </div>
        </aside>
      </div>

      <div class="headerGlow" aria-hidden="true"></div>
    </header>

    <!-- Content -->
    {docs.length === 0 ? (
      <section class="empty" aria-label="No documents yet">
        <div class="emptyCard">
          <h2 class="emptyTitle">No documents yet</h2>
          <p class="emptyDesc">
            We’re re-ingesting the authoritative DOCX sources into a fresh collection.
            This page will become the master index as content lands.
          </p>

          <div class="emptyCtas">
            <a class="btn primary" href={hrefStart}>Guided Overview</a>
            <a class="btn" href={hrefBackbone}>Backbone</a>
            <a class="btn ghost" href={hrefProposal}>Open Proposal</a>
          </div>

          <div class="emptyHint">
            <strong>Tip:</strong> Start with <a href={hrefStart}>Start Here</a> to get the map — then return to the Library
            to cite/share individual sections.
          </div>
        </div>
      </section>
    ) : (
      <section class="results" aria-label="Library documents">
        <div class="resultsHead">
          <div class="resultsLeft">
            <h2 class="sectionTitle">Browse</h2>
            <p class="sectionKicker">
              Cards below link to each document route. Filters/search can be added after ingestion.
            </p>
          </div>

          <div class="resultsRight" aria-label="Placeholder controls">
            <a class="chip" href="#all">All</a>
            <a class="chip" href="#core">Core</a>
            <a class="chip" href="#appendix">Appendix</a>
            <span class="chip muted" aria-hidden="true">Search (soon)</span>
          </div>
        </div>

        <div id="all" class="grid" role="list">
          {docs.map((d) => {
            const href = routeFor(d);
            const label = labelFor(d);
            const sub = subtitleFor(d);

            return (
              <a class="docCard" href={href} role="listitem">
                <div class="docTop">
                  <p class="docEyebrow">Document</p>
                  <h3 class="docTitle">{label}</h3>
                  {sub ? (
                    <p class="docDesc">{sub}</p>
                  ) : (
                    <p class="docDesc placeholder">Plain-language section • shareable page</p>
                  )}
                </div>

                <div class="docFoot">
                  <span class="docPath" title={href}>{href}</span>
                  <span class="arrow">Open</span>
                </div>
              </a>
            );
          })}
        </div>
      </section>
    )}
  </main>

  <style>
    /* styles unchanged */
    .library{
      display:flex;
      flex-direction:column;
      gap: 18px;
      padding: 6px 0 18px;
    }

    /* Header (token-safe) */
    .header{
      position: relative;
      border-radius: 18px;
      padding: 18px;
      border: 1px solid var(--stroke);
      background:
        radial-gradient(1200px 420px at 20% 0%, rgba(var(--brand), .14), transparent 60%),
        radial-gradient(900px 460px at 90% 20%, rgba(var(--brand2), .10), transparent 55%),
        var(--surface);
      overflow:hidden;
      box-shadow: var(--shadow-sm);
    }

    .headerGlow{
      position:absolute;
      inset:auto -10% -60% -10%;
      height: 260px;
      background:
        radial-gradient(closest-side, rgba(var(--brand), .20), transparent 70%),
        radial-gradient(closest-side, rgba(var(--brand2), .12), transparent 70%);
      filter: blur(12px);
      opacity: .75;
      pointer-events:none;
    }

    @media (max-width: 980px){
      .headerInner{ grid-template-columns: 1fr; }
      .panelGrid{ grid-template-columns: 1fr; }
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</SiteLayout>
